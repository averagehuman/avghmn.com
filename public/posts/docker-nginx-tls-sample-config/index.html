<!doctype html><html data-current="post" lang="en"><head><meta charset="utf-8"><link rel="dns-prefetch" href="https://identity.netlify.com"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Docker nginx reverse proxy sample config</title><meta name="description" content="Software development notes"><link rel="stylesheet" href="/static/fontawesome/css/all.css"><link rel="stylesheet" href="/static/css/prism.css"><link rel="stylesheet" href="/static/css/averagehuman.css"><script>window.netlifyIdentity&&window.netlifyIdentity.on("init",n=>{n||window.netlifyIdentity.on("login",()=>{document.location.href="/admin/"})});</script></head><body><header class="site-header"><div class="container"><nav class="navbar is-transparent" role="navigation" aria-label="main navigation"><div class="navbar-brand"><a class="navbar-item is-size-4 has-text-white" href="/"><strong>average human</strong></a></div><div id="navbarBasicExample" class="navbar-menu"><div class="navbar-end"><div class="navbar-item"><div class="buttons"><a class="button" href="/" title="Home"><span class="icon"><i class="fas fa-lg fa-home"></i></span> </a><a class="button" href="/feed.xml" title="RSS Feed"><span class="icon"><i class="fas fa-lg fa-rss"></i></span> </a><a class="button" href="https://github.com/averagehuman" title="Github"><span class="icon"><i class="fab fa-2x fa-github" style="font-size:1.75em"></i></span></a></div></div></div></div></nav></div></header><main><div class="container"><div class="page-container"><article><h1 class="is-size-4">Docker nginx reverse proxy sample config</h1><p class="has-text-grey is-italic"><small><time datetime="2022-01-09">09 Jan 2022</time></small></p><hr><p>Local development configuration for setting up docker-compose to run nginx as reverse proxy to a dynamic web application or static site, for example.</p><h2 id="update-hosts">Update hosts</h2><p>Assuming the site domain is <strong>devtest.local</strong>, update <code>/etc/hosts</code> (or <code>C:/Windows/System32/drivers/etc/hosts</code>) by adding this line to the end of the file:</p><pre><code>127.0.0.1   devtest.local
</code></pre><h2 id="server-certificates">Server Certificates</h2><p>In the directory where the <code>docker-compose.yml</code> file lives, create <code>etc</code> and <code>etc/certs</code> sub-directories and copy the server's certificate and private key to the latter directory.</p><p>For example, using the script described in <a href="/posts/x509-certs-javascript/">the previous post</a>:</p><pre class="language-bash"><code class="language-bash">$ node mkcert.js devtest.local<br>Creating self-signed certificate <span class="token punctuation">(</span>CN<span class="token operator">=</span>devtest.local<span class="token punctuation">)</span><span class="token punctuation">..</span>.<br><br>$ <span class="token function">chmod</span> <span class="token number">400</span> devtest.local.key<br><br>$ <span class="token function">ls</span><br>devtest.local.crt devtest.local.key<br></code></pre><h2 id="docker-compose.yml">docker-compose.yml</h2><p>Then the <code>docker compose</code> configuration file should look similar to:</p><pre class="language-yaml"><code class="language-yaml"><br><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span><br><span class="token key atrule">services</span><span class="token punctuation">:</span><br><br>  <span class="token key atrule">nginx</span><span class="token punctuation">:</span><br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest<br>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> ./etc/certs<span class="token punctuation">:</span>/etc/nginx/certs<br>      <span class="token punctuation">-</span> ./etc/nginx.conf<span class="token punctuation">:</span>/etc/nginx/conf.d/default.conf<br>    <span class="token key atrule">ports</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">"8443:443"</span><br>    <span class="token key atrule">networks</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> backend<br>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> server54<br>    <span class="token key atrule">links</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> server54<br><br><span class="token key atrule">networks</span><span class="token punctuation">:</span><br>  <span class="token key atrule">backend</span><span class="token punctuation">:</span><br>    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge<br></code></pre><p>Notice that in this example the container's 443 port is mapped to 8443 in the host. So the url to visit, after running <code>docker compose up</code>, is:</p><pre><code>    https://devtest.local:8443
</code></pre><p>But you could also have 443 on both host and container so as not to require the explicit port in the url.</p><h2 id="nginx.conf-(sample)">nginx.conf (sample)</h2><p>The following is a generic nginx configuration file based on <a href="https://github.com/nginx-proxy/nginx-proxy/blob/main/nginx.tmpl">this template</a> - update to suit your needs. This should exist as <code>etc/nginx.conf</code> to match the docker compose config above.</p><pre class="language-nginx"><code class="language-nginx"><br><span class="token directive"><span class="token keyword">map</span> <span class="token variable">$http_x_forwarded_proto</span> <span class="token variable">$proxy_x_forwarded_proto</span></span> <span class="token punctuation">{</span><br>  <span class="token directive"><span class="token keyword">default</span> <span class="token variable">$http_x_forwarded_proto</span></span><span class="token punctuation">;</span><br>  ''      $scheme<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token directive"><span class="token keyword">map</span> <span class="token variable">$http_x_forwarded_port</span> <span class="token variable">$proxy_x_forwarded_port</span></span> <span class="token punctuation">{</span><br>  <span class="token directive"><span class="token keyword">default</span> <span class="token variable">$http_x_forwarded_port</span></span><span class="token punctuation">;</span><br>  ''      $server_port<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token directive"><span class="token keyword">map</span> <span class="token variable">$http_upgrade</span> <span class="token variable">$proxy_connection</span></span> <span class="token punctuation">{</span><br>  <span class="token directive"><span class="token keyword">default</span> upgrade</span><span class="token punctuation">;</span><br>  '' <span class="token directive"><span class="token keyword">close</span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token comment"># Apply fix for very long server names</span><br><span class="token directive"><span class="token keyword">server_names_hash_bucket_size</span> <span class="token number">128</span></span><span class="token punctuation">;</span><br><span class="token comment"># Set appropriate X-Forwarded-Ssl header based on $proxy_x_forwarded_proto</span><br><span class="token directive"><span class="token keyword">map</span> <span class="token variable">$proxy_x_forwarded_proto</span> <span class="token variable">$proxy_x_forwarded_ssl</span></span> <span class="token punctuation">{</span><br>  <span class="token directive"><span class="token keyword">default</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span><br>  <span class="token directive"><span class="token keyword">https</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token directive"><span class="token keyword">gzip_types</span> text/plain text/css application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript</span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">log_format</span> vhost <span class="token string">'<span class="token variable">$host</span> <span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local]</span> '</span><br>                 <span class="token string">'"<span class="token variable">$request</span>" <span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> '</span><br>                 <span class="token string">'"<span class="token variable">$http_referer</span>" "<span class="token variable">$http_user_agent</span>" '</span><br>                 <span class="token string">'"<span class="token variable">$upstream_addr</span>"'</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">access_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">ssl_ciphers</span> <span class="token string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384'</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span><br><span class="token comment"># resolver 127.0.0.11;</span><br><span class="token comment"># HTTP 1.1 support</span><br><span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token variable">$proxy_connection</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$proxy_x_forwarded_proto</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Ssl <span class="token variable">$proxy_x_forwarded_ssl</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Port <span class="token variable">$proxy_x_forwarded_port</span></span><span class="token punctuation">;</span><br><span class="token comment"># Mitigate httpoxy attack (see README for details)</span><br><span class="token directive"><span class="token keyword">proxy_set_header</span> Proxy <span class="token string">""</span></span><span class="token punctuation">;</span><br><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span><br>        <span class="token directive"><span class="token keyword">server_name</span> _</span><span class="token punctuation">;</span> <span class="token comment"># This is just an invalid value which will never trigger on a real hostname.</span><br>        <span class="token directive"><span class="token keyword">server_tokens</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">access_log</span> /var/log/nginx/access.log vhost</span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">return</span> <span class="token number">503</span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span><br>        <span class="token directive"><span class="token keyword">server_name</span> devtest.local</span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span> <span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">access_log</span> /var/log/nginx/access.log vhost</span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span><br>                <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span>:8443<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span><br>        <span class="token directive"><span class="token keyword">server_name</span> devtest.local</span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl http2</span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">access_log</span> /var/log/nginx/access.log vhost</span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">5m</span></span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">ssl_session_cache</span> shared:SSL:50m</span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">ssl_session_tickets</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span><br><br>        <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/nginx/certs/devtest.local.crt</span><span class="token punctuation">;</span><br>        <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/nginx/certs/devtest.local.key</span><span class="token punctuation">;</span><br><br>        <span class="token directive"><span class="token keyword">add_header</span> Strict-Transport-Security <span class="token string">"max-age=31536000"</span> always</span><span class="token punctuation">;</span><br><br>        <span class="token directive"><span class="token keyword">root</span> /usr/share/nginx</span><span class="token punctuation">;</span><br><br>        <span class="token directive"><span class="token keyword">location</span> = /</span> <span class="token punctuation">{</span><br>            <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span>:8443/</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></article></div></div></main><footer class="footer"><div class="content container"><p><small>Copyright averagehuman.com 2022. All rights reserved.</small></p></div></footer></body></html>