<!doctype html><html data-current="post" lang="en"><head><meta charset="utf-8"><link rel="dns-prefetch" href="https://identity.netlify.com"><meta name="viewport" content="width=device-width,initial-scale=1"><title>X.509 certificates with javascript</title><meta name="description" content="Software development notes"><link rel="stylesheet" href="/static/fontawesome/css/all.css"><link rel="stylesheet" href="/static/css/prism.css"><link rel="stylesheet" href="/static/css/averagehuman.css"><script>window.netlifyIdentity&&window.netlifyIdentity.on("init",n=>{n||window.netlifyIdentity.on("login",()=>{document.location.href="/admin/"})});</script></head><body><header class="site-header"><div class="container"><nav class="navbar is-transparent" role="navigation" aria-label="main navigation"><div class="navbar-brand"><a class="navbar-item is-size-4 has-text-white" href="/"><strong>average blog</strong></a></div><div id="navbarBasicExample" class="navbar-menu"><div class="navbar-end"><div class="navbar-item"><div class="buttons"><a class="button" href="/" title="Home"><span class="icon"><i class="fas fa-lg fa-home"></i></span> </a><a class="button" href="/feed.xml" title="RSS Feed"><span class="icon"><i class="fas fa-lg fa-rss"></i></span> </a><a class="button" href="https://github.com/averagehuman" title="Github"><span class="icon"><i class="fab fa-2x fa-github" style="font-size:1.75em"></i></span></a></div></div></div></div></nav></div></header><main><div class="container"><div class="page-container"><article><h1 class="is-size-4">X.509 certificates with javascript</h1><p class="has-text-grey is-italic"><small><time datetime="2022-01-01">01 Jan 2022</time></small></p><hr><p>The following javascript module uses <a href="https://github.com/digitalbazaar/forge">node-forge</a> to generate X.509 certificates for local development.</p><h2 id="keypair.js">keypair.js</h2><pre class="language-javascript"><code class="language-javascript"><span class="token comment">/* keypair.js */</span><br><br><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> forge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-forge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> pki <span class="token operator">=</span> forge<span class="token punctuation">.</span>pki<span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token constant">DEFAULT_EXPIRY_YEARS</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token constant">DEFAULT_KEY_LENGTH</span> <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Returns a random unique hexidecimal string<br> *<br> * @param {string=} text - optional namespace<br> */</span><br><span class="token keyword">function</span> <span class="token function">mkSerialNumber</span><span class="token punctuation">(</span><span class="token parameter">namespace</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> rnd <span class="token operator">=</span> <span class="token string">'.'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>namespace <span class="token operator">+</span> rnd<span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// Prepend '00' to prevent negative serial number (https://github.com/digitalbazaar/forge/issues/349)</span><br>    <span class="token keyword">return</span> <span class="token string">'00'</span> <span class="token operator">+</span> hash<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * Generate a PKI X.509 certificate and private key signed by the given Certificate Authority key<br> *<br> * @param {string} caCertPem<br> * @param {string} caKeyPem<br> * @param {Object[]} subject<br> * @param {Object[]} extensions<br> * @param {Object=} options<br> */</span><br><span class="token keyword">function</span> <span class="token function">mkKeyPair</span><span class="token punctuation">(</span><span class="token parameter">caCertPem<span class="token punctuation">,</span> caKeyPem<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">(</span>options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>    opts<span class="token punctuation">.</span>keyLength <span class="token operator">=</span> opts<span class="token punctuation">.</span>keyLength <span class="token operator">||</span> <span class="token constant">DEFAULT_KEY_LENGTH</span><span class="token punctuation">;</span><br>    opts<span class="token punctuation">.</span>expiryYears <span class="token operator">=</span> opts<span class="token punctuation">.</span>expiryYears <span class="token operator">||</span> <span class="token constant">DEFAULT_EXPIRY_YEARS</span><span class="token punctuation">;</span><br>    opts<span class="token punctuation">.</span>serialNumber <span class="token operator">=</span> opts<span class="token punctuation">.</span>serialNumber <span class="token operator">||</span> <span class="token function">mkSerialNumber</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">const</span> caCert <span class="token operator">=</span> pki<span class="token punctuation">.</span><span class="token function">certificateFromPem</span><span class="token punctuation">(</span>caCertPem<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> caKey <span class="token operator">=</span> pki<span class="token punctuation">.</span><span class="token function">privateKeyFromPem</span><span class="token punctuation">(</span>caKeyPem<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> keys <span class="token operator">=</span> pki<span class="token punctuation">.</span>rsa<span class="token punctuation">.</span><span class="token function">generateKeyPair</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>keyLength<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> cert <span class="token operator">=</span> pki<span class="token punctuation">.</span><span class="token function">createCertificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> currentYear <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    cert<span class="token punctuation">.</span>publicKey <span class="token operator">=</span> keys<span class="token punctuation">.</span>publicKey<span class="token punctuation">;</span><br>    cert<span class="token punctuation">.</span>serialNumber <span class="token operator">=</span> opts<span class="token punctuation">.</span>serialNumber<span class="token punctuation">;</span><br>    cert<span class="token punctuation">.</span>validity<span class="token punctuation">.</span>notBefore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cert<span class="token punctuation">.</span>validity<span class="token punctuation">.</span>notAfter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cert<span class="token punctuation">.</span>validity<span class="token punctuation">.</span>notAfter<span class="token punctuation">.</span><span class="token function">setFullYear</span><span class="token punctuation">(</span>currentYear <span class="token operator">+</span> opts<span class="token punctuation">.</span>expiryYears<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cert<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cert<span class="token punctuation">.</span><span class="token function">setIssuer</span><span class="token punctuation">(</span>caCert<span class="token punctuation">.</span>subject<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cert<span class="token punctuation">.</span><span class="token function">setExtensions</span><span class="token punctuation">(</span>extensions<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    cert<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>caKey<span class="token punctuation">,</span> forge<span class="token punctuation">.</span>md<span class="token punctuation">.</span>sha256<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        privateKeyPem<span class="token operator">:</span> pki<span class="token punctuation">.</span><span class="token function">privateKeyToPem</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        certPem<span class="token operator">:</span> pki<span class="token punctuation">.</span><span class="token function">certificateToPem</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mkKeyPair<span class="token punctuation">;</span><br></code></pre><h2 id="ca-certificate">CA Certificate</h2><p>The required root CA certificate can be generated with openssl commands such as:</p><pre class="language-bash"><code class="language-bash">$ openssl genrsa -out rootCA.pem.key <span class="token number">2048</span><br>$ openssl req -x509 -sha256 -new -nodes -key rootCA.pem.key -days <span class="token number">3650</span> -out rootCA.pem.crt</code></pre><h2 id="example">Example</h2><p>There is a command line usage example on <a href="https://github.com/averagehuman/js-mk-cert/blob/main/mkcert.js">github</a>.</p><pre class="language-bash"><code class="language-bash">$ node mkcert.js <span class="token number">10.0</span>.1.1<br>Creating self-signed certificate <span class="token punctuation">(</span>CN<span class="token operator">=</span><span class="token number">10.0</span>.1.1<span class="token punctuation">)</span><span class="token punctuation">..</span>.<br>Wrote file: <span class="token number">10.0</span>.1.1.crt<br>Wrote file: <span class="token number">10.0</span>.1.1.key<br></code></pre><p>That script doesn't automatically restrict permissions on the key file, so you should do that, eg.:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">chmod</span> <span class="token number">400</span> <span class="token number">10.0</span>.1.1.key</code></pre><h2 id="see-also">See Also</h2><ul><li><a href="https://github.com/FiloSottile/mkcert">github.com/FiloSottile/mkcert</a> - a more complete solution written in go that installs a CA cert to the system trust store of the host OS.</li></ul></article></div></div></main><footer class="footer"><div class="content container"><p><small>Copyright averagehuman.com 2022. All rights reserved.</small></p></div></footer></body></html>